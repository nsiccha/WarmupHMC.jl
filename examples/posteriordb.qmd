---
title:  WarmupHMC.jl example - using posteriordb reference draws
jupyter: julia-1.8
execute:
  daemon: 999999
---

```{julia}
push!(LOAD_PATH,"../src/")
using DynamicObjects, WarmupHMC
using Distributions, Statistics, LinearAlgebra, ForwardDiff, PosteriorDB, BridgeStan, DataFrames
using Plots

pdb = PosteriorDB.database()
post = PosteriorDB.posterior(pdb, "eight_schools-eight_schools_centered")
mod = PosteriorDB.model(post)
data = PosteriorDB.dataset(post)
ref = PosteriorDB.reference_posterior(post)
df = DataFrame(PosteriorDB.load(ref))
constrained_draws = hcat([vcat(col...) for col in eachcol(df)]...)
bmod = StanModel(
    stan_file=PosteriorDB.path(PosteriorDB.implementation(mod, "stan")), 
    data=PosteriorDB.load(data, String)
)
unconstrained_draws = vcat([
    param_unconstrain(bmod, collect(row))' for row in eachrow(constrained_draws)
]...)

"""
A matrix of unconstrained draws from the centered eight schools model
"""
@dynamic_object EightSchoolsDraws unconstrained_draws::Matrix

udraws = EightSchoolsDraws(unconstrained_draws)
Base.size(what::EightSchoolsDraws, args...) = size(what.unconstrained_draws, args...)
Base.axes(what::EightSchoolsDraws, args...) = axes(what.unconstrained_draws, args...)
# https://github.com/stan-dev/posteriordb/blob/master/posterior_database/models/stan/eight_schools_centered.stan
log_sds(what::EightSchoolsDraws) = what.unconstrained_draws[:, end]
means(what::EightSchoolsDraws) = what.unconstrained_draws[:, end-1]
x1s(what::EightSchoolsDraws) = what.unconstrained_draws[:, 1:end-2]
subset(what::EightSchoolsDraws, no_draws=size(what, 1) รท 2) = EightSchoolsDraws(
    what.unconstrained_draws[rand(axes(what, 1), no_draws), :]
)
scatter_funnel(what::EightSchoolsDraws, i=1) = scatter(what.x1s[:, i], what.log_sds)

function klps_plot(x1s, means, log_sds, cs=LinRange(0, 1, 100))
    kls = klps(x1s, means, log_sds, cs)
    kls .-= minimum(kls)
    kls ./= maximum(kls)
    plot(cs, kls)
end

udraws = subset(udraws, 100)
plot([
    klps_plot(x1, udraws.means, udraws.log_sds) for x1 in eachcol(udraws.x1s)
]...)
```  